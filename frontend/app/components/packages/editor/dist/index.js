import { Node, nodeInputRule, mergeAttributes, ReactNodeViewRenderer, ReactRenderer, NodeViewWrapper, useEditor, EditorContent } from '@tiptap/react';
import { forwardRef, useState, useEffect, useImperativeHandle, useCallback, useRef, useLayoutEffect } from 'react';
import { useDebouncedCallback } from 'use-debounce';
import { PluginKey, Plugin } from '@tiptap/pm/state';
import { Decoration, DecorationSet } from '@tiptap/pm/view';
import { cn, HoverCard, HoverCardTrigger, Badge, HoverCardContent, Toggle, DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem } from '@bistudio-feedback/ui';
import { Text, Heading1, Heading2, Heading3, List, ListOrdered, TextQuote, Code, ImageIcon, VideoIcon, AtSign, CalendarDays, Bold, Italic, Underline, MoreHorizontal, Strikethrough, Heading, Quote, Code2, Image as Image$1, Video, Upload, Undo, Redo } from 'lucide-react';
import { jsx, jsxs } from 'react/jsx-runtime';
import St from '@tiptap/starter-kit';
import Dt from '@tiptap/extension-horizontal-rule';
import { Extension, InputRule } from '@tiptap/core';
import Pt from '@tiptap/extension-link';
import Lt from '@tiptap/extension-placeholder';
import Ve from '@tiptap/suggestion';
import ot from 'tippy.js';
import Rt from '@tiptap/extension-underline';
import Ot from '@tiptap/extension-floating-menu';
import vt from '@tiptap/extension-mention';
import Ut from '@tiptap/extension-image';
import { generateHTML } from '@tiptap/html';

var g={FILE_TYPE_NOT_SUPPORTED:"FILE_TYPE_NOT_SUPPORTED",IMAGE_FILE_SIZE_TOO_BIG:"IMAGE_FILE_SIZE_TOO_BIG",VIDEO_FILE_SIZE_TOO_BIG:"VIDEO_FILE_SIZE_TOO_BIG",UPLOAD_LOADING:"UPLOAD_LOADING",UPLOAD_SUCCESS:"UPLOAD_SUCCESS",UPLOAD_ERROR:"UPLOAD_ERROR"};function Wt(e,t){if(typeof document>"u")throw new Error("Document is not defined");document.addEventListener(e,t);}function Qt(e,t){if(typeof document>"u")throw new Error("Document is not defined");document.removeEventListener(e,t);}function f(e,t){if(typeof document>"u")throw new Error("Document is not defined");let o=new CustomEvent(e,{detail:t});document.dispatchEvent(o);}function D(){let e=Math.random()*46656|0,t=Math.random()*46656|0,o=("000"+e.toString(36)).slice(-3),r=("000"+t.toString(36)).slice(-3);return o+r}var N=new PluginKey("upload-image"),he=new Plugin({key:N,state:{init(){return DecorationSet.empty},apply(e,t){t=t.map(e.mapping,e.doc);let o=e.getMeta(this);if(o&&o.add){let{id:r,pos:n,src:s}=o.add,c=document.createElement("div");c.setAttribute("class","img-placeholder");let l=document.createElement("img");l.setAttribute("class","opacity-40 rounded-lg border border-gray-200 dark:border-gray-500"),l.src=s,c.appendChild(l);let d=Decoration.widget(n+1,c,{id:r});t=t.add(e.doc,[d]);}else o&&o.remove&&(t=t.remove(t.find(null,null,r=>r.id==o.remove.id)));return t}},props:{decorations(e){return this.getState(e)}}}),A=he;function be(e,t){let r=N.getState(e).find(null,null,n=>n.id==t);return r.length?r[0].from:null}function E(e,t,o){if(e.type.includes("image/")){if(e.size/1024/1024>10){f(g.IMAGE_FILE_SIZE_TOO_BIG,"File size too big (max 10MB).");return}}else {f(g.FILE_TYPE_NOT_SUPPORTED,"File type not supported.");return}let r={},n=t.state.tr;n.selection.empty||n.deleteSelection();let s=URL.createObjectURL(e);n.setMeta(N,{add:{id:r,pos:o,src:s}}),t.dispatch(n),ye(e).then(({error:c,url:l})=>{let{schema:d}=t.state,i=be(t.state,r);if(i!=null){if(c){let m=t.state.tr.delete(i,i).setMeta(N,{remove:{id:r}});t.dispatch(m);}else {let m=typeof l=="object"?s:l,b=d.nodes.image.create({src:m}),C=t.state.tr.replaceWith(i,i,b).setMeta(N,{remove:{id:r}});t.dispatch(C);}URL.revokeObjectURL(s);}});}var ye=async e=>{let t=new FormData;t.append("image",e);let o=D();f(g.UPLOAD_LOADING,{uploadId:o,loading:"Uploading image...",success:"Image uploaded successfully.",error:"Error uploading image. Please try again."});try{let r=await fetch("/resources/upload-image",{method:"POST",body:t});if(r.ok){let{url:n}=await r.json();return await new Promise((s,c)=>{let l=new Image;l.src=n,l.onload=()=>{f(g.UPLOAD_SUCCESS,{uploadId:o}),s({url:n,error:!1});},l.onerror=c;})}else {let n="Error uploading image. Please try again.";throw new Error(n)}}catch{return f(g.UPLOAD_ERROR,{uploadId:o}),{error:true,url:null}}};var S=new PluginKey("upload-video"),we=new Plugin({key:S,state:{init(){return DecorationSet.empty},apply(e,t){t=t.map(e.mapping,e.doc);let o=e.getMeta(this);if(o&&o.add){let{id:r,pos:n,url:s}=o.add,c=document.createElement("div");c.setAttribute("class","video-placeholder");let l=document.createElement("video");l.setAttribute("class","opacity-40 rounded-lg border border-gray-200 dark:border-gray-500"),l.preload="metadata";let d=document.createElement("source");d.src=`${s}#t=0.5`,l.appendChild(d),c.appendChild(l);let i=Decoration.widget(n+1,c,{id:r});t=t.add(e.doc,[i]);}else o&&o.remove&&(t=t.remove(t.find(null,null,r=>r.id==o.remove.id)));return t}},props:{decorations(e){return this.getState(e)}}}),H=we;function Ce(e,t){let r=S.getState(e).find(null,null,n=>n.id==t);return r.length?r[0].from:null}function k(e,t,o){if(e.type.includes("video/")){if(e.size/1024/1024>50){f(g.VIDEO_FILE_SIZE_TOO_BIG,"File size too big (max 50MB).");return}}else {f(g.FILE_TYPE_NOT_SUPPORTED,"File type not supported.");return}let r={},n=t.state.tr;n.selection.empty||n.deleteSelection();let s=URL.createObjectURL(e);n.setMeta(S,{add:{id:r,pos:o,url:s}}),t.dispatch(n),Te(e).then(({error:c,url:l})=>{let{schema:d}=t.state,i=Ce(t.state,r);if(i!=null){if(c){let m=t.state.tr.delete(i,i).setMeta(S,{remove:{id:r}});t.dispatch(m);}else {let m=typeof l=="object"?s:l,b=d.nodes.video.create({src:m}),C=t.state.tr.replaceWith(i,i,b).setMeta(S,{remove:{id:r}});t.dispatch(C);}URL.revokeObjectURL(s);}});}var Te=async e=>{let t=new FormData;t.append("video",e);let o=D();f(g.UPLOAD_LOADING,{uploadId:o,loading:"Uploading video...",success:"Video uploaded successfully.",error:"Error uploading video. Please try again."});try{let r=await fetch("/resources/upload-video",{method:"POST",body:t});if(r.ok){let{url:n}=await r.json();return f(g.UPLOAD_SUCCESS,{uploadId:o}),{url:n,error:!1}}else {let n="Error uploading video. Please try again.";throw new Error(n)}}catch{return f(g.UPLOAD_ERROR,{uploadId:o}),{error:true,url:null}}};var I=({editor:e,children:t,isComment:o})=>e?jsxs("div",{className:"absolute left-0 top-0 flex w-full items-center justify-between rounded-t-lg border-b bg-white p-2 dark:bg-gray-800",children:[jsxs("div",{className:"flex items-center gap-x-2",children:[jsx(He,{editor:e,className:"flex gap-x-2"}),jsx(Re,{editor:e,className:"block xl:hidden"}),jsx(Ue,{editor:e,className:"hidden gap-x-2 xl:flex"}),jsx(Ae,{editor:e,className:"hidden gap-x-2 xl:flex"}),jsx(Oe,{editor:e,className:"hidden gap-x-2 xl:flex"})]}),jsx(Le,{editor:e,children:t,className:"flex items-center gap-x-2"})]}):null;function Le({editor:e,children:t,className:o}){return jsxs("div",{className:o,children:[jsx("button",{className:"hidden md:flex",onClick:r=>{r.preventDefault(),e.chain().focus().undo().run();},children:jsx(Undo,{className:"h-4 w-4"})}),jsx("button",{className:"hidden md:flex",onClick:r=>{r.preventDefault(),e.chain().focus().redo().run();},children:jsx(Redo,{className:"h-4 w-4"})}),t]})}function Re({editor:e,className:t}){return jsx("div",{className:t,children:jsxs(DropdownMenu,{children:[jsx(DropdownMenuTrigger,{className:"hover:bg-muted h-9 rounded-md px-2.5 transition-all",children:jsx(MoreHorizontal,{className:"h-4 w-4"})}),jsxs(DropdownMenuContent,{className:"dark:bg-gray-700",children:[jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleStrike().run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("strike")?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Strikethrough,{}),"Strikethrough"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleHeading({level:1}).run();},className:cn("flex cursor-pointer gap-x-2 rounded-md  p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("heading",{level:1})?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Heading,{}),"Heading 1"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleHeading({level:2}).run();},className:cn("flex cursor-pointer gap-x-2 rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("heading",{level:2})?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Heading2,{}),"Heading 2"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleHeading({level:3}).run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("heading",{level:3})?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Heading3,{}),"Heading 3"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleBulletList().run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("bulletList")?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(List,{}),"List"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleOrderedList().run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("orderedList")?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(ListOrdered,{}),"Ordered List"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleBlockquote().run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("blockquote")?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Quote,{}),"Blockquote"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleCodeBlock().run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("codeBlock")?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Code2,{}),"Code"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().insertMention().run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("mentionSuggestion")?"bg-slate-300 dark:bg-gray-900":""),children:[jsx(AtSign,{}),"Mention"]}),jsxs(DropdownMenuItem,{className:"flex cursor-pointer gap-x-2 rounded-md  p-1 hover:bg-slate-200 hover:dark:bg-gray-800",onClick:o=>{o.preventDefault(),e.chain().focus().deleteRange({from:e.state.selection.from,to:e.state.selection.to+1}).run();let r=document.createElement("input");r.type="file",r.accept="image/*",r.onchange=async()=>{if(r.files?.length){let n=r.files[0],s=e.view.state.selection.from;E(n,e.view,s);}},r.click();},children:[jsx(Image$1,{}),"Image"]}),jsxs(DropdownMenuItem,{className:"flex cursor-pointer gap-x-2 rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",onClick:o=>{o.preventDefault(),e.chain().focus().deleteRange({from:e.state.selection.from,to:e.state.selection.to+1}).run();let r=document.createElement("input");r.type="file",r.accept="video/*",r.onchange=async()=>{if(r.files?.length){let n=r.files[0],s=e.view.state.selection.from;k(n,e.view,s);}},r.click();},children:[jsx(Video,{}),"Video"]})]})]})})}function Oe({editor:e,className:t}){return jsx("div",{className:t,children:jsxs(DropdownMenu,{children:[jsx(DropdownMenuTrigger,{className:"hover:bg-muted h-9 rounded-md px-2.5 transition-all",children:jsx(Upload,{className:"h-4 w-4"})}),jsxs(DropdownMenuContent,{className:"dark:bg-gray-700",children:[jsxs(DropdownMenuItem,{className:"flex cursor-pointer gap-x-2 rounded-md  p-1 hover:bg-slate-200 hover:dark:bg-gray-800",onClick:o=>{o.preventDefault(),e.chain().focus().deleteRange({from:e.state.selection.from,to:e.state.selection.to+1}).run();let r=document.createElement("input");r.type="file",r.accept="image/*",r.onchange=async()=>{if(r.files?.length){let n=r.files[0],s=e.view.state.selection.from;E(n,e.view,s);}},r.click();},children:[jsx(Image$1,{}),"Image"]}),jsxs(DropdownMenuItem,{className:"flex cursor-pointer gap-x-2 rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",onClick:o=>{o.preventDefault(),e.chain().focus().deleteRange({from:e.state.selection.from,to:e.state.selection.to+1}).run();let r=document.createElement("input");r.type="file",r.accept="video/*",r.onchange=async()=>{if(r.files?.length){let n=r.files[0],s=e.view.state.selection.from;k(n,e.view,s);}},r.click();},children:[jsx(Video,{}),"Video"]})]})]})})}function Ue({editor:e,className:t}){return jsx("div",{className:t,children:jsxs(DropdownMenu,{children:[jsx(DropdownMenuTrigger,{className:"hover:bg-muted h-9 rounded-md px-2.5 transition-all",children:jsx(MoreHorizontal,{className:"h-4 w-4"})}),jsxs(DropdownMenuContent,{className:"dark:bg-gray-700",children:[jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleStrike().run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("strike")?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Strikethrough,{}),"Strikethrough"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleHeading({level:1}).run();},className:cn("flex cursor-pointer gap-x-2 rounded-md  p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("heading",{level:1})?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Heading,{}),"Heading 1"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleHeading({level:2}).run();},className:cn("flex cursor-pointer gap-x-2 rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("heading",{level:2})?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Heading2,{}),"Heading 2"]}),jsxs(DropdownMenuItem,{onClick:o=>{o.preventDefault(),e.chain().focus().toggleHeading({level:3}).run();},className:cn("flex cursor-pointer gap-x-2  rounded-md p-1 hover:bg-slate-200 hover:dark:bg-gray-800",e.isActive("heading",{level:3})?"border bg-slate-300 dark:bg-gray-900":""),children:[jsx(Heading3,{}),"Heading 3"]})]})]})})}function Ae({editor:e,className:t}){return jsxs("div",{className:t,children:[jsx(Toggle,{size:"sm",onClick:()=>{e.chain().focus().toggleBulletList().run();},children:jsx(List,{className:"h-4 w-4"})}),jsx(Toggle,{size:"sm",onClick:()=>{e.chain().focus().toggleOrderedList().run();},children:jsx(ListOrdered,{className:"h-4 w-4"})}),jsx(Toggle,{size:"sm",onClick:()=>{e.chain().focus().toggleBlockquote().run();},children:jsx(Quote,{className:"h-4 w-4"})}),jsx(Toggle,{size:"sm",onClick:()=>{e.chain().focus().toggleCodeBlock().run();},children:jsx(Code2,{className:"h-4 w-4"})}),jsx(Toggle,{size:"sm",onClick:()=>{e.chain().focus().insertMention().run();},children:jsx(AtSign,{className:"h-4 w-4"})})]})}function He({editor:e,className:t}){return jsxs("div",{className:t,children:[jsx(Toggle,{size:"sm",onClick:()=>{e.chain().focus().toggleBold().run();},children:jsx(Bold,{className:"h-4 w-4"})}),jsx(Toggle,{size:"sm",onClick:()=>{e.chain().focus().toggleItalic().run();},children:jsx(Italic,{className:"h-4 w-4"})}),jsx(Toggle,{size:"sm",onClick:()=>{e.chain().focus().toggleUnderline().run();},children:jsx(Underline,{className:"h-4 w-4"})})]})}var rt=Extension.create({name:"slash-command",addOptions(){return {suggestion:{char:"/",command:({editor:e,range:t,props:o})=>{o.command({editor:e,range:t});}}}},addProseMirrorPlugins(){return [Ve({editor:this.editor,...this.options.suggestion})]}}),nt=({query:e})=>[{title:"Text",description:"Just start typing with plain text.",searchTerms:["p","paragraph"],icon:jsx(Text,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).toggleNode("paragraph","paragraph").run();}},{title:"Heading 1",description:"Big section heading.",searchTerms:["title","big","large"],icon:jsx(Heading1,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).setNode("heading",{level:1}).run();}},{title:"Heading 2",description:"Medium section heading.",searchTerms:["subtitle","medium"],icon:jsx(Heading2,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).setNode("heading",{level:2}).run();}},{title:"Heading 3",description:"Small section heading.",searchTerms:["subtitle","small"],icon:jsx(Heading3,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).setNode("heading",{level:3}).run();}},{title:"Bullet List",description:"Create a simple bullet list.",searchTerms:["unordered","point"],icon:jsx(List,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).toggleBulletList().run();}},{title:"Numbered List",description:"Create a list with numbering.",searchTerms:["ordered"],icon:jsx(ListOrdered,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).toggleOrderedList().run();}},{title:"Quote",description:"Capture a quote.",searchTerms:["blockquote"],icon:jsx(TextQuote,{size:18}),command:({editor:t,range:o})=>t.chain().focus().deleteRange(o).toggleNode("paragraph","paragraph").toggleBlockquote().run()},{title:"Code",description:"Capture a code snippet.",searchTerms:["codeblock"],icon:jsx(Code,{size:18}),command:({editor:t,range:o})=>t.chain().focus().deleteRange(o).toggleCodeBlock().run()},{title:"Image",description:"Upload an image from your computer.",searchTerms:["photo","picture","media"],icon:jsx(ImageIcon,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).run();let r=document.createElement("input");r.type="file",r.accept="image/*",r.onchange=async()=>{if(r.files?.length){let n=r.files[0],s=t.view.state.selection.from;E(n,t.view,s);}},r.click();}},{title:"Video",description:"Upload a video from your computer.",searchTerms:["video","screen capture","media"],icon:jsx(VideoIcon,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).run();let r=document.createElement("input");r.type="file",r.accept="video/*",r.onchange=async()=>{if(r.files?.length){let n=r.files[0],s=t.view.state.selection.from;k(n,t.view,s);}},r.click();}},{title:"Mention",description:"Mention a member.",searchTerms:["mention","member","user"],icon:jsx(AtSign,{size:18}),command:({editor:t,range:o})=>{t.chain().focus().deleteRange(o).insertContent("@").run();}}].filter(t=>{if(typeof e=="string"&&e.length>0){let o=e.toLowerCase();return t.title.toLowerCase().includes(o)||t.description.toLowerCase().includes(o)||t.searchTerms&&t.searchTerms.some(r=>r.includes(o))}return  true}),at=(e,t)=>{let o=e.offsetHeight,r=t?t.offsetHeight:0,n=t.offsetTop,s=n+r;n<e.scrollTop?e.scrollTop-=e.scrollTop-n+5:s>o+e.scrollTop&&(e.scrollTop+=s-o-e.scrollTop+5);},st=({items:e,command:t,editor:o,range:r})=>{let[n,s]=useState(0),c=useCallback(d=>{let i=e[d];i&&t(i);},[t,e]);useEffect(()=>{let d=["ArrowUp","ArrowDown","Enter"],i=m=>{if(d.includes(m.key))return m.preventDefault(),m.key==="ArrowUp"?(s((n+e.length-1)%e.length),true):m.key==="ArrowDown"?(s((n+1)%e.length),true):m.key==="Enter"?(c(n),true):false};return document.addEventListener("keydown",i),()=>{document.removeEventListener("keydown",i);}},[e,n,s,c]),useEffect(()=>{s(0);},[e]);let l=useRef(null);return useLayoutEffect(()=>{let d=l?.current,i=d?.children[n];i&&d&&at(d,i);},[n]),e.length>0?jsx("div",{id:"slash-command",ref:l,className:"border-border z-50 h-auto max-h-[330px] w-72 space-y-1 overflow-y-auto rounded-md border bg-white p-1 shadow-md transition-all dark:bg-gray-700",children:e.map((d,i)=>jsxs("button",{className:`flex w-full items-center space-x-2 rounded-md px-2 py-1.5 text-left text-sm hover:bg-gray-200 dark:hover:bg-gray-600 ${i===n?"bg-gray-200 dark:bg-gray-600":""}`,onClick:()=>c(i),children:[jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-md border border-gray-200 bg-white dark:border-gray-500 dark:bg-gray-700",children:d.icon}),jsxs("div",{children:[jsx("p",{className:"font-medium",children:d.title}),jsx("p",{className:"text-muted-foreground text-xs",children:d.description})]})]},i))}):null},it=()=>{let e=null,t=null;return {onStart:o=>{e=new ReactRenderer(st,{props:o,editor:o.editor}),t=ot("body",{getReferenceClientRect:o.clientRect,appendTo:()=>document.body,content:e.element,showOnCreate:true,interactive:true,trigger:"manual",placement:"bottom-start"});},onUpdate:o=>{e?.updateProps(o),t&&t[0].setProps({getReferenceClientRect:o.clientRect});},onKeyDown:o=>o.event.key==="Escape"?(t?.[0].hide(),true):e?.ref?.onKeyDown(o),onExit:()=>{t?.[0].destroy(),e?.destroy();}}},dt=rt.configure({suggestion:{items:nt,render:it}}),Q=dt;var mt=/!\[(.+|:?)]\((\S+)(?:(?:\s+)["'](\S+)["'])?\)/,X=Node.create({name:"video",group:"block",draggable:true,addOptions(){return {HTMLAttributes:{}}},addAttributes(){return {width:{default:null},height:{default:null},src:{default:null,parseHTML:e=>e.getAttribute("src"),renderHTML:e=>({src:e.src})}}},parseHTML(){return [{tag:"video",getAttrs:e=>({src:e.getAttribute("src")})}]},renderHTML({HTMLAttributes:e}){return ["video",mergeAttributes(this.options.HTMLAttributes,{controls:"true",controlsList:"nodownload"},e),["source",e]]},addCommands(){return {setVideo:e=>({commands:t})=>t.insertContent(`<video controls="true" controlsList="nodownload" src="${e}" />`),toggleVideo:()=>({commands:e})=>e.toggleNode(this.name,"paragraph")}},addInputRules(){return [nodeInputRule({find:mt,type:this.type,getAttributes:e=>{let[,,t]=e;return {src:t}}})]},addProseMirrorPlugins(){return [H]}});var ee=e=>jsx(NodeViewWrapper,{as:"span",children:jsxs(HoverCard,{"data-label":e.node.attrs.user.username,"data-id":e.node.attrs.id,children:[jsx(HoverCardTrigger,{className:"cursor-pointer",children:jsx("a",{href:`/members/${e.node.attrs.user.username}`,children:jsxs(Badge,{variant:"green",children:["@",e.node.attrs.user.username]})})}),jsx(HoverCardContent,{className:"not-prose w-80 bg-slate-50 dark:bg-slate-900",children:jsxs("div",{className:"flex justify-center space-x-10",children:[jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-white ring-8 ring-white",children:jsx("img",{src:`https://api.dicebear.com/7.x/identicon/svg?seed=${e.node.attrs.id}`,className:"w-8",alt:"avatar"})}),jsxs("div",{className:"",children:[jsx("a",{className:"hover:underline",href:`/members/${e.node.attrs.user.username}`,children:jsxs("h4",{className:"text-sm font-semibold",children:["@",e.node.attrs.user.username]})}),jsxs("div",{className:"flex items-center pt-2",children:[jsx(CalendarDays,{className:"mr-2 h-4 w-4 opacity-70"})," ",jsx("span",{className:"text-muted-foreground text-xs",children:"Joined December 2021"})]})]})]})})]})});var te=vt.extend({name:"customMention",addAttributes(){return {id:{default:null},reputation:{default:null},user:{default:null}}},addNodeView(){return ReactNodeViewRenderer(ee)},renderHTML({HTMLAttributes:e,node:t}){return ["span",e]}});var re=forwardRef((e,t)=>{let[o,r]=useState(0),n=d=>{if(d>=e.items.length)return;let i=e.items[d],m={id:i.id,reputation:i.reputation,user:{username:i.user.username,id:i.user.id}};e.command(m);},s=()=>{r((o+e.items.length-1)%e.items.length);},c=()=>{r((o+1)%e.items.length);},l=()=>{n(o);};return useEffect(()=>r(0),[e.items]),useImperativeHandle(t,()=>({onKeyDown:({event:d})=>d.key==="ArrowUp"?(s(),true):d.key==="ArrowDown"?(c(),true):d.key==="Enter"?(l(),true):false})),jsx("div",{children:e.items.length?jsx("div",{className:"scrollbar-thin max-h-36 overflow-y-auto bg-gray-50 p-1 dark:bg-gray-900",children:e.items.map((d,i)=>jsxs("div",{className:cn("flex cursor-pointer items-center justify-between gap-x-2 hover:bg-gray-200 hover:dark:bg-gray-950",i===o&&"bg-gray-200 dark:bg-gray-950"),onClick:()=>n(i),children:[jsx("img",{src:`https://api.dicebear.com/7.x/identicon/svg?seed=${d.id}`,alt:"",className:"m-1 h-6 w-6 rounded-full"}),jsx("div",{className:cn("m-1 px-2 py-1"),children:d.user.username})]},d.id))}):jsx("div",{className:"bg-gray-50 p-1 dark:bg-gray-900",children:jsx("p",{children:"Enter at least one character"})})})});re.displayName="SuggestionList";var ne=re;var ae={bottom:0,height:0,left:0,right:0,top:0,width:0,x:0,y:0,toJSON(){return {}}},se=e=>({items:async({query:t})=>t?(await e(t)??[]).members:[],render:()=>{let t,o;return {onStart:r=>{t=new ReactRenderer(ne,{props:r,editor:r.editor}),o=ot("body",{getReferenceClientRect:()=>r.clientRect?.()??ae,appendTo:()=>document.body,content:t.element,showOnCreate:true,interactive:true,trigger:"manual",placement:"bottom-start"})[0];},onUpdate(r){t?.updateProps(r),o?.setProps({getReferenceClientRect:()=>r.clientRect?.()??ae});},onKeyDown(r){return r.event.key==="Escape"?(o?.hide(),true):t?.ref?t.ref.onKeyDown(r):false},onExit(){o?.destroy(),t?.destroy(),o=void 0,t=void 0;}}}});var At=Ut.extend({addAttributes(){return {...this.parent?.(),width:{default:null},height:{default:null}}},addProseMirrorPlugins(){return [A]}}),x=class{extensions=[];constructor(){this.extensions=[];}addExtension(t){return this.extensions.push(t),this}addStarterKit({disableHeading:t=true}){let o=St.configure({heading:t?false:{levels:[1,2,3]},bulletList:{HTMLAttributes:{class:"list-disc list-outside leading-3 -mt-2"}},orderedList:{HTMLAttributes:{class:"list-decimal list-outside leading-3 -mt-2"}},listItem:{HTMLAttributes:{class:"leading-normal -mb-2"}},blockquote:{HTMLAttributes:{class:"border-l-4 border-gray-700 dark:border-gray-300"}},codeBlock:{HTMLAttributes:{class:"rounded-sm text-foreground dark:bg-gray-700 bg-gray-100 p-5 font-mono font-medium"}},code:{HTMLAttributes:{class:"rounded-md text-foreground dark:bg-gray-700 bg-gray-100 px-1.5 py-1 font-mono font-medium",spellcheck:"false"}},horizontalRule:false,dropcursor:{color:"#DBEAFE",width:4},gapcursor:false});return this.addExtension(o),this}addHorizontalRule(){let t=Dt.extend({addInputRules(){return [new InputRule({find:/^(?:---|â€”-|___\s|\*\*\*\s)$/,handler:({state:o,range:r})=>{let n={},{tr:s}=o,c=r.from,l=r.to;s.insert(c-1,this.type.create(n)).delete(s.mapping.map(c),s.mapping.map(l));}})]}}).configure({HTMLAttributes:{class:"mt-4 mb-6 border-t border-gray-300 dark:border-gray-600"}});return this.addExtension(t),this}addLink(){let t=Pt.configure({HTMLAttributes:{class:"text-gray-700 dark:text-gray-200 underline underline-offset-[3px] hover:text-gray-900 dark:hover:text-white transition-colors cursor-pointer"}});return this.addExtension(t),this}addPlaceholder(){let t=Lt.configure({placeholder:({node:o})=>o.type.name==="heading"?`Heading ${o.attrs.level}`:"Press '/' for commands",includeChildren:true});return this.addExtension(t),this}addSlashCommand(){return this.addExtension(Q),this}addUnderline(){return this.addExtension(Rt),this}addCustomImage(){let t=At.configure({allowBase64:true,HTMLAttributes:{class:"rounded-md border border-border"}});return this.addExtension(t),this}addVideo(){return this.addExtension(X),this}addFloatingMenu(){return this.addExtension(Ot),this}addCustomMention(t){let o=te.configure({suggestion:se(t)});return this.addExtension(o),this}initServerExtensions(t){let{disableHeading:o=false}=t||{};return this.addStarterKit({disableHeading:o}).addLink().addPlaceholder().addSlashCommand().addUnderline().addCustomImage().addVideo().addCustomMention(()=>Promise.resolve([])).addFloatingMenu(),this}build(){return this.extensions}};var P={attributes:{class:"prose prose-stone dark:prose-invert prose-code:before:content-none prose-code:after:content-none focus:outline-none max-w-full"},handleDOMEvents:{keydown:(e,t)=>{if(["ArrowUp","ArrowDown","Enter"].includes(t.key)&&document.querySelector("#slash-command"))return  true}},handlePaste:(e,t)=>{if(t.clipboardData&&t.clipboardData.files&&t.clipboardData.files[0]){t.preventDefault();let o=t.clipboardData.files[0],r=e.state.selection.from;return o.type.includes("image/")?E(o,e,r):o.type.includes("video/")?k(o,e,r):f(g.FILE_TYPE_NOT_SUPPORTED,"File type not supported."),true}return  false},handleDrop:(e,t,o,r)=>{if(!r&&t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files[0]){t.preventDefault();let n=t.dataTransfer.files[0],s=e.posAtCoords({left:t.clientX,top:t.clientY});return s&&(n.type.includes("image/")?E(n,e,s.pos):n.type.includes("video/")?k(n,e,s.pos):f(g.FILE_TYPE_NOT_SUPPORTED,"File type not supported.")),true}return  false}};function Vt({onChange:e,callbacks:{getMentionOptions:t},clearEditor:o}){let[r,n]=useState("Saved"),[s,c]=useState(false),l=useDebouncedCallback(async({editor:m})=>{let b=m.getJSON();n("Saving..."),e(b),setTimeout(()=>{n("Saved");},50);},50),d=new x().addStarterKit({disableHeading:true}).addLink().addPlaceholder().addSlashCommand().addUnderline().addCustomImage().addVideo().addFloatingMenu().addCustomMention(t),i=useEditor({extensions:d.build(),editorProps:P,content:"",onUpdate:m=>{n("Unsaved"),l(m);}});return useEffect(()=>{i&&!s&&c(true);},[i,s]),useEffect(()=>{i?.commands.clearContent();},[o]),jsxs("div",{onClick:()=>{i?.chain().focus().run();},className:"relative min-h-[300px] w-full overflow-y-auto rounded-lg border border-gray-100 bg-white p-8 px-6 shadow-sm sm:px-8 dark:border-gray-600 dark:bg-gray-700",children:[i&&jsx(I,{editor:i}),jsx(EditorContent,{className:"mt-10",editor:i,spellCheck:false})]})}function qt({onChange:e,callbacks:{getMentionOptions:t},defaultContent:o}){let[r,n]=useState(o),[s,c]=useState("Saved"),[l,d]=useState(false),i=useDebouncedCallback(async({editor:C})=>{let ue=C.getJSON();c("Saving..."),e(ue),setTimeout(()=>{c("Saved");},50);},50),m=new x().addStarterKit({disableHeading:false}).addLink().addPlaceholder().addSlashCommand().addUnderline().addCustomImage().addVideo().addFloatingMenu().addCustomMention(t).addPlaceholder(),b=useEditor({extensions:m.build(),editorProps:P,autofocus:"end",content:r,immediatelyRender:false,onUpdate:C=>{c("Unsaved"),i(C);}});return useEffect(()=>{b&&r&&!l&&(b.commands.setContent(r),d(true));},[b,l,r]),jsxs("div",{onClick:()=>{b?.chain().focus().run();},className:"relative min-h-[300px] w-full overflow-y-auto rounded-lg border border-gray-100 bg-white p-8 px-6 shadow-sm sm:px-8 dark:border-gray-600 dark:bg-gray-700",children:[b&&jsx(I,{editor:b}),jsx(EditorContent,{className:"mt-10",editor:b})]})}var Zt=new x().initServerExtensions(),Jt=e=>{try{return generateHTML(e,Zt.build())}catch{throw Error("Error: generating richtext html")}};

export { Vt as CommentEditor, g as EVENTS, x as ExtensionBuilder, qt as IssueEditor, Jt as generateRichtextHtml, f as publish, Wt as subscribe, Qt as unsubscribe };
